<!doctype html>
<html>

<head>
    <style>
        /*Element with id="container" will follow the regular positioning flow of the html document*/
        #container {
            position: relative;
        }

        /*Within an element with id="container", elements with id="canvas" will have an absolute position
              Elements with id="overlay" (in general) will have an absolute position
              Absolute position is unaffected by rest of the html doc
              This allows for the generation of our grid of buttons on top of a canvas element*/
        #container canvas,
        #overlay {
            position: absolute;
        }

        canvas {
            border: 1px solid black;
        }

        .categories-buttons {
            /*grid of 10 columns, each being 70 pixels wide*/
            display: grid;
            grid-template-columns: 70px 70px 70px 70px 70px 70px 70px 70px 70px 70px;
        }
    </style>
</head>

<body>
    <h1>MINESWEEPER</h1>
    <!--Pre-Game start-up menu/info-->
    <button id="start_game_button">Start Game</button>
    <br><br>
    <label for="mineCount">Mines:</label>
    <select id="mineCount">
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15" selected>15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
    </select>
    <p id="start_info">This will update to display info about the game settings upon clicking the start game button</p>

    <!--Create the canvas and overlay-->
    <div id="container">
        <canvas id="canvas" width="700" height="500"></canvas>
        <div id="overlay" class="categories-buttons"></div>
    </div>
    <script>

        let NUM_MINES; // change this to the result of the input form
        const minefield = []; // moving to global scope so other functions can reference this easily
        let mouse_x = 0;
        let mouse_y = 0;

        //get access to the start game button
        var start_game_button = document.getElementById("start_game_button");

        //when the start button is clicked, chosen settings will be applied
        start_game_button.addEventListener("click", apply_settings);

        //get access to the divider and the canvas elements
        var div = document.getElementsByClassName("categories-buttons")[0];
        const context = document.getElementById("canvas").getContext("2d");

        //for a 10x10 grid, we will have 100 buttons
        for (var i = 0; i < 100; i++) {

            //create a button element and store it in a tempButton variable
            var tempButton = document.createElement("button");

            //give the tempButton an id (will be converted to a string)
            tempButton.id = i;

            // give the button a flag to tell if it is flagged or not
            tempButton.is_flagged = 0;

            //make the height of the button be 50px (1/10 * height of the canvas)
            tempButton.style.height = "50px";

            // add left-click event handler to the button
            tempButton.addEventListener("click", left_click);

            // f-key event listener needs to know whether or not mouse is hovering over
            // button.
            tempButton.is_hovering = false;
            tempButton.addEventListener("mouseenter", function () {
                this.is_hovering = true;
            });
            tempButton.addEventListener("mouseleave", function () {
                this.is_hovering = false;
            });

            //append the tempButton to the element that div is "pointing" to
            div.append(tempButton);
        }
        // track mouse's coordinates for flagging spaces
        document.addEventListener("mousemove", function () {
            mouse_x = event.clientX;
            mouse_y = event.clientY;
        });
        // event listener for f-key/flagging
        document.addEventListener("keypress", function (event) {
            let button = document.elementFromPoint(mouse_x, mouse_y);
            if (button.is_hovering && event.key === "f") {
                if (!button.is_flagged && !button.disabled) {
                    button.innerHTML = "FLAG";
                    button.style.fontWeight = "bold";
                    button.style.fontSize = "20px";
                    button.style.color = "#008CBA";

                    button.is_flagged = !button.is_flagged;
                } else if (button.is_flagged && !button.disabled) {
                    button.innerHTML = "";
                    button.is_flagged = !button.is_flagged;
                }
            }
        });

        function apply_settings() {
            //TODO: add extra settings if implemented in future
            NUM_MINES = document.getElementById("mineCount").value;

            //get the settings paragraph
            var start_info = document.getElementById("start_info");

            //change the text to show settings to validate that they've been applied
            start_info.innerText = `Game started with ${NUM_MINES} mines`;

        }

        function left_click() {
            // "this" refers to the HTML element that called this function
            const id = parseInt(this.id);

            // generate the mine positions only after the first click
            if (typeof left_click.initialized == 'undefined') {
                left_click.initialized = true;
                generate_array(NUM_MINES, id);
            }

            // we can disable buttons once their number is revealed, so this is all we need to check
            if (!this.is_flagged) {
                if (minefield[this.id] == "*") {
                    gameOver();
                }
                reveal(this);
            }
        }

        function gameOver() {
            // TODO: Add game over screen and reveal all bombs
            console.log("You lose :(");
        }

        function reveal(tile) {
            // TODO:
            // end the game if this is called on a bomb initially, otherwise it is a
            // recursive or BFS (ideally) reveal function that reveals all numbers adjacent (including diagonally)
            // to the revealed tile if it is empty (no adjacent bombs).
            // Then, reveal all other empty adjacent tiles with BFS.
            console.log(`revealing ${tile.id}`);

            // we don't need to click the button anymore, we can disable it
            tile.disabled = true;

            let row = parseInt(tile.id / 10);
            let column = tile.id % 10;

            // set the text on the button to the number of adjacent mines here
            if (minefield[row][column] == "*") {
                tile.innerHTML = "*";
                tile.style.color = "black";
            } else if (minefield[row][column] != 0) {
                tile.innerHTML = minefield[row][column]; // TODO reveal # of mines nearby
            }

            // change the style of the button. Should probably be moved up to css eventually
            tile.style.fontWeight = "bold";
            tile.style.fontSize = "20px";

            // here we can assign a color based on the revealed number by checking minefield[id]. #111 was black
            if (minefield[row][column] == 1) {
                tile.style.color = "blue";
            }
            else if (minefield[row][column] == 2) {
                tile.style.color = "green";
            }
            else if (minefield[row][column] == 3) {
                tile.style.color = "red";
            }
            else if (minefield[row][column] == 4) {
                tile.style.color = "purple";
            }
            else if (minefield[row][column] == 5) {
                tile.style.color = "maroon";
            }
            else if (minefield[row][column] == 6) {
                tile.style.color = "teal";
            }
            else if (minefield[row][column] == 7) {
                tile.style.color = "black";
            }
            else if (minefield[row][column] == 8) {
                tile.style.color = "gray";
            }
        }

        function generate_array(mines_amount, start_index) {
            // Generates minefield without mine in start_index
            // const minefield = new Array(100); moved to global scope, at least for now
            genfield = new Array(100);
            genfield.fill("_", 0, 100 - mines_amount);
            genfield.fill("*", 100 - mines_amount, 100);
            console.log("mines: " + genfield);
            shuffle(genfield);
            console.log("start: " + genfield);
            shuffle(genfield);
            if (genfield[start_index] == "*") {
                while (genfield[start_index] == "*") {
                    shuffle(genfield);
                    console.log("iteration: " + genfield);
                }
            }
            genfield[start_index] = 0;
            console.log("end: " + genfield);
            while (genfield.length) {
                minefield.push(genfield.splice(0, 10));
            }

            console.log(minefield);

            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    let mines_nearby = 0;
                    if (minefield[i][j] != "*") {
                        if (i - 1 >= 0 && j >= 0 && minefield[i - 1][j - 1] == "*") { // Top Left
                            mines_nearby++;
                        }
                        if (i - 1 >= 0 && minefield[i - 1][j] == "*") {     // Top
                            mines_nearby++;
                        }
                        if (i - 1 >= 0 && j + 1 < 10 && minefield[i - 1][j + 1] == "*") {   // Top Right
                            mines_nearby++;
                        }
                        if (j - 1 >= 0 && minefield[i][j - 1] == "*") {   // Left
                            mines_nearby++;
                        }
                        if (j + 1 < 10 && minefield[i][j + 1] == "*") {  // Right
                            mines_nearby++;
                        }
                        if (i + 1 < 10 && j - 1 >= 0 && minefield[i + 1][j - 1] == "*") {  // Bottom Left
                            mines_nearby++;
                        }
                        if (i + 1 < 10 && minefield[i + 1][j] == "*") { // Bottom
                            mines_nearby++;
                        }
                        if (i + 1 < 10 && j + 1 < 10 && minefield[i + 1][j + 1] == "*") {   // Bottom Right
                            mines_nearby++;
                        }
                        console.log(mines_nearby);
                        minefield[i][j] = mines_nearby;
                    }
                }
            }
            for (let i = 0; i < 10; i++) {
                let row = "";
                for (let j = 0; j < 10; j++) {
                    row += minefield[i][j] + " "
                }
                console.log(row);
            }

        }

        // https://javascript.info/task/shuffle
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

    </script>
</body>

</html>